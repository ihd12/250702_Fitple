<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <title>ì§€ë„ì™€ ë§¤ë¬¼ ë¦¬ìŠ¤íŠ¸</title>
    <link rel="stylesheet" th:href="@{/css/housing-map.css}">
</head>

<body>
<h2>ì„ëŒ€ ì£¼íƒ ì •ë³´</h2>
<div id="search-panel"><strong>ì§€ì—­ ê²€ìƒ‰:</strong><select id="sido-select"></select><select id="sigungu-select"></select>
    <strong>í˜¸ì¶œ ê°œìˆ˜:</strong>
    <select id="num-of-rows-select">
        <option value="5">5ê°œ</option>
        <option value="10" selected>10ê°œ</option>
        <option value="25">25ê°œ</option>
    </select>
    <button id="search-btn">ê²€ìƒ‰</button><button id="toggle-advanced-search-btn">ìƒì„¸ ê²€ìƒ‰</button></div>
<div id="advanced-filter-panel">
    <div class="filter-group"><label>ë³´ì¦ê¸ˆ(ë§Œì›)</label><input type="number" id="min-deposit" placeholder="ìµœì†Œ"><span>~</span><input type="number" id="max-deposit" placeholder="ìµœëŒ€"></div>
    <div class="filter-group"><label>ì›”ì„¸(ë§Œì›)</label><input type="number" id="min-rent" placeholder="ìµœì†Œ"><span>~</span><input type="number" id="max-rent" placeholder="ìµœëŒ€"></div>
    <div class="filter-group"><label>ì „ìš©ë©´ì (ã¡)</label><input type="number" id="min-area" placeholder="ìµœì†Œ"><span>~</span><input type="number" id="max-area" placeholder="ìµœëŒ€"></div>
    <div class="filter-group preset-buttons"><label></label><button class="area-preset-btn" data-min="" data-max="33">~33ã¡</button><button class="area-preset-btn" data-min="33" data-max="66">33~66ã¡</button><button class="area-preset-btn" data-min="66" data-max="99">66~99ã¡</button><button class="area-preset-btn" data-min="99" data-max="132">99~132ã¡</button></div>
    <div class="filter-group"><label>ì£¼íƒìœ í˜•</label>
        <div class="preset-buttons"><button class="type-filter-btn active" data-type="">ì „ì²´</button><button class="type-filter-btn" data-type="ë‹¤ê°€êµ¬ì£¼íƒ">ë‹¤ê°€êµ¬</button><button class="type-filter-btn" data-type="ë‹¤ì„¸ëŒ€ì£¼íƒ">ë‹¤ì„¸ëŒ€</button><button class="type-filter-btn" data-type="ì•„íŒŒíŠ¸">ì•„íŒŒíŠ¸</button><button class="type-filter-btn" data-type="ì˜¤í”¼ìŠ¤í…”">ì˜¤í”¼ìŠ¤í…”</button><button class="type-filter-btn" data-type="etc">ê¸°íƒ€</button></div>
    </div>
    <div class="filter-group"><label></label><button id="apply-filter-btn">í•„í„° ì ìš©</button><button id="reset-filter-btn">ì´ˆê¸°í™”</button></div>
</div>
<div id="info-panel">
    <div class="info-item">
        <span class="info-label">ğŸ“ í˜„ì¬ ì£¼ì†Œ</span>
        <span id="info-addr"></span>
    </div>
    <div class="info-item">
        <span class="info-label">ğŸŒ ìœ„ë„ / ê²½ë„</span>
        <span><span id="info-lat"></span>, <span id="info-lng"></span></span>
    </div>
    <div class="info-item">
        <span class="info-label">ğŸ”¢ ë²•ì •ë™ ì½”ë“œ</span>
        <span id="info-code"></span>
    </div>
</div>
    <div id="main-container">
    <div id="map"></div>
    <div id="list-panel">
        <h3>ë§¤ë¬¼ ë¦¬ìŠ¤íŠ¸</h3>
        <div id="loading-animation" style="display:none; text-align:center; padding:20px;">
            <div class="loader"></div>
            <p>ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>
        <div id="list-content">
            <ul id="property-list"></ul>
        </div>
    </div>
</div>
<div id="modal-wrapper">
    <div id="modal-content">
        <div id="modal-header">
            <h2>ë§¤ë¬¼ ìƒì„¸ ì •ë³´</h2><button id="close-modal-btn">âœ–</button>
        </div>
        <div id="modal-body"></div>
    </div>
</div>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a0e30d98f6dfa0bc355f0bdba19e03da&libraries=services&autoload=false"></script>
<script>
    var latitude = 37.566826,
        longitude = 126.9786567,
        geocoder, map, markers = [],
        activeInfoWindow = null,
        currentHousingList = [],
        selectedHouseType = "",
        currentReplyPage = 1,
        repliesPerPage = 5,
        allReplies = [];
    const currentUserId = "testUser123";
    const sidoSelect = document.getElementById('sido-select'),
        sigunguSelect = document.getElementById('sigungu-select'),
        modalWrapper = document.getElementById('modal-wrapper'),
        modalBody = document.getElementById('modal-body'),
        closeModalBtn = document.getElementById('close-modal-btn');
    const regionData = {
        "11": {
            name: "ì„œìš¸íŠ¹ë³„ì‹œ",
            sigungu: {
                "110": "ì¢…ë¡œêµ¬",
                "140": "ì¤‘êµ¬",
                "170": "ìš©ì‚°êµ¬",
                "200": "ì„±ë™êµ¬",
                "215": "ê´‘ì§„êµ¬",
                "230": "ë™ëŒ€ë¬¸êµ¬",
                "260": "ì¤‘ë‘êµ¬",
                "290": "ì„±ë¶êµ¬",
                "305": "ê°•ë¶êµ¬",
                "320": "ë„ë´‰êµ¬",
                "350": "ë…¸ì›êµ¬",
                "380": "ì€í‰êµ¬",
                "410": "ì„œëŒ€ë¬¸êµ¬",
                "440": "ë§ˆí¬êµ¬",
                "470": "ì–‘ì²œêµ¬",
                "500": "ê°•ì„œêµ¬",
                "530": "êµ¬ë¡œêµ¬",
                "545": "ê¸ˆì²œêµ¬",
                "560": "ì˜ë“±í¬êµ¬",
                "590": "ë™ì‘êµ¬",
                "620": "ê´€ì•…êµ¬",
                "650": "ì„œì´ˆêµ¬",
                "680": "ê°•ë‚¨êµ¬",
                "710": "ì†¡íŒŒêµ¬",
                "740": "ê°•ë™êµ¬"
            }
        },
        "26": {
            name: "ë¶€ì‚°ê´‘ì—­ì‹œ",
            sigungu: {
                "110": "ì¤‘êµ¬",
                "140": "ì„œêµ¬",
                "170": "ë™êµ¬",
                "200": "ì˜ë„êµ¬",
                "230": "ë¶€ì‚°ì§„êµ¬",
                "260": "ë™ë˜êµ¬",
                "290": "ë‚¨êµ¬",
                "320": "ë¶êµ¬",
                "350": "í•´ìš´ëŒ€êµ¬",
                "380": "ì‚¬í•˜êµ¬",
                "410": "ê¸ˆì •êµ¬",
                "440": "ê°•ì„œêµ¬",
                "470": "ì—°ì œêµ¬",
                "500": "ìˆ˜ì˜êµ¬",
                "530": "ì‚¬ìƒêµ¬",
                "710": "ê¸°ì¥êµ°"
            }
        },
        "27": {
            name: "ëŒ€êµ¬ê´‘ì—­ì‹œ",
            sigungu: {
                "110": "ì¤‘êµ¬",
                "140": "ë™êµ¬",
                "170": "ì„œêµ¬",
                "200": "ë‚¨êµ¬",
                "230": "ë¶êµ¬",
                "260": "ìˆ˜ì„±êµ¬",
                "290": "ë‹¬ì„œêµ¬",
                "710": "ë‹¬ì„±êµ°"
            }
        },
        "28": {
            name: "ì¸ì²œê´‘ì—­ì‹œ",
            sigungu: {
                "110": "ì¤‘êµ¬",
                "140": "ë™êµ¬",
                "177": "ë¯¸ì¶”í™€êµ¬",
                "185": "ì—°ìˆ˜êµ¬",
                "200": "ë‚¨ë™êµ¬",
                "237": "ë¶€í‰êµ¬",
                "245": "ê³„ì–‘êµ¬",
                "260": "ì„œêµ¬",
                "710": "ê°•í™”êµ°",
                "720": "ì˜¹ì§„êµ°"
            }
        },
        "29": {
            name: "ê´‘ì£¼ê´‘ì—­ì‹œ",
            sigungu: {
                "110": "ë™êµ¬",
                "140": "ì„œêµ¬",
                "155": "ë‚¨êµ¬",
                "170": "ë¶êµ¬",
                "200": "ê´‘ì‚°êµ¬"
            }
        },
        "30": {
            name: "ëŒ€ì „ê´‘ì—­ì‹œ",
            sigungu: {
                "110": "ë™êµ¬",
                "140": "ì¤‘êµ¬",
                "170": "ì„œêµ¬",
                "200": "ìœ ì„±êµ¬",
                "230": "ëŒ€ë•êµ¬"
            }
        },
        "31": {
            name: "ìš¸ì‚°ê´‘ì—­ì‹œ",
            sigungu: {
                "110": "ì¤‘êµ¬",
                "140": "ë‚¨êµ¬",
                "170": "ë™êµ¬",
                "200": "ë¶êµ¬",
                "710": "ìš¸ì£¼êµ°"
            }
        },
        "36": {
            name: "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ",
            sigungu: {
                "110": "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ"
            }
        },
        "41": {
            name: "ê²½ê¸°",
            sigungu: {
                "111": "ìˆ˜ì›ì‹œ ì¥ì•ˆêµ¬",
                "113": "ìˆ˜ì›ì‹œ ê¶Œì„ êµ¬",
                "115": "ìˆ˜ì›ì‹œ íŒ”ë‹¬êµ¬",
                "117": "ìˆ˜ì›ì‹œ ì˜í†µêµ¬",
                "131": "ì„±ë‚¨ì‹œ ìˆ˜ì •êµ¬",
                "133": "ì„±ë‚¨ì‹œ ì¤‘ì›êµ¬",
                "135": "ì„±ë‚¨ì‹œ ë¶„ë‹¹êµ¬",
                "150": "ì˜ì •ë¶€ì‹œ",
                "171": "ì•ˆì–‘ì‹œ ë§Œì•ˆêµ¬",
                "173": "ì•ˆì–‘ì‹œ ë™ì•ˆêµ¬",
                "190": "ë¶€ì²œì‹œ",
                "210": "ê´‘ëª…ì‹œ",
                "220": "í‰íƒì‹œ",
                "250": "ë™ë‘ì²œì‹œ",
                "271": "ì•ˆì‚°ì‹œ ìƒë¡êµ¬",
                "273": "ì•ˆì‚°ì‹œ ë‹¨ì›êµ¬",
                "281": "ê³ ì–‘ì‹œ ë•ì–‘êµ¬",
                "285": "ê³ ì–‘ì‹œ ì¼ì‚°ë™êµ¬",
                "287": "ê³ ì–‘ì‹œ ì¼ì‚°ì„œêµ¬",
                "290": "ê³¼ì²œì‹œ",
                "310": "êµ¬ë¦¬ì‹œ",
                "360": "ë‚¨ì–‘ì£¼ì‹œ",
                "370": "ì˜¤ì‚°ì‹œ",
                "390": "ì‹œí¥ì‹œ",
                "410": "êµ°í¬ì‹œ",
                "430": "ì˜ì™•ì‹œ",
                "450": "í•˜ë‚¨ì‹œ",
                "461": "ìš©ì¸ì‹œ ì²˜ì¸êµ¬",
                "463": "ìš©ì¸ì‹œ ê¸°í¥êµ¬",
                "465": "ìš©ì¸ì‹œ ìˆ˜ì§€êµ¬",
                "480": "íŒŒì£¼ì‹œ",
                "500": "ì´ì²œì‹œ",
                "550": "ì•ˆì„±ì‹œ",
                "570": "ê¹€í¬ì‹œ",
                "590": "í™”ì„±ì‹œ",
                "610": "ê´‘ì£¼ì‹œ",
                "630": "ì–‘ì£¼ì‹œ",
                "650": "í¬ì²œì‹œ",
                "670": "ì—¬ì£¼ì‹œ",
                "800": "ì—°ì²œêµ°",
                "820": "ê°€í‰êµ°",
                "830": "ì–‘í‰êµ°"
            }
        },
        "51": {
            name: "ê°•ì›íŠ¹ë³„ìì¹˜ë„",
            sigungu: {
                "110": "ì¶˜ì²œì‹œ",
                "130": "ì›ì£¼ì‹œ",
                "150": "ê°•ë¦‰ì‹œ",
                "170": "ë™í•´ì‹œ",
                "190": "íƒœë°±ì‹œ",
                "210": "ì†ì´ˆì‹œ",
                "230": "ì‚¼ì²™ì‹œ",
                "720": "í™ì²œêµ°",
                "730": "íš¡ì„±êµ°",
                "750": "ì˜ì›”êµ°",
                "760": "í‰ì°½êµ°",
                "770": "ì •ì„ êµ°",
                "780": "ì² ì›êµ°",
                "790": "í™”ì²œêµ°",
                "800": "ì–‘êµ¬êµ°",
                "810": "ì¸ì œêµ°",
                "820": "ê³ ì„±êµ°",
                "830": "ì–‘ì–‘êµ°"
            }
        },
        "43": {
            name: "ì¶©ë¶",
            sigungu: {
                "111": "ì²­ì£¼ì‹œ ìƒë‹¹êµ¬",
                "112": "ì²­ì£¼ì‹œ ì„œì›êµ¬",
                "113": "ì²­ì£¼ì‹œ í¥ë•êµ¬",
                "114": "ì²­ì£¼ì‹œ ì²­ì›êµ¬",
                "130": "ì¶©ì£¼ì‹œ",
                "150": "ì œì²œì‹œ",
                "720": "ë³´ì€êµ°",
                "730": "ì˜¥ì²œêµ°",
                "740": "ì˜ë™êµ°",
                "745": "ì¦í‰êµ°",
                "750": "ì§„ì²œêµ°",
                "760": "ê´´ì‚°êµ°",
                "770": "ìŒì„±êµ°",
                "800": "ë‹¨ì–‘êµ°"
            }
        },
        "44": {
            name: "ì¶©ë‚¨",
            sigungu: {
                "131": "ì²œì•ˆì‹œ ë™ë‚¨êµ¬",
                "133": "ì²œì•ˆì‹œ ì„œë¶êµ¬",
                "150": "ê³µì£¼ì‹œ",
                "180": "ë³´ë ¹ì‹œ",
                "200": "ì•„ì‚°ì‹œ",
                "210": "ì„œì‚°ì‹œ",
                "230": "ë…¼ì‚°ì‹œ",
                "250": "ê³„ë£¡ì‹œ",
                "270": "ë‹¹ì§„ì‹œ",
                "710": "ê¸ˆì‚°êµ°",
                "760": "ë¶€ì—¬êµ°",
                "770": "ì„œì²œêµ°",
                "790": "ì²­ì–‘êµ°",
                "800": "í™ì„±êµ°",
                "810": "ì˜ˆì‚°êµ°",
                "825": "íƒœì•ˆêµ°"
            }
        },
        "52": {
            name: "ì „ë¶íŠ¹ë³„ìì¹˜ë„",
            sigungu: {
                "111": "ì „ì£¼ì‹œ ì™„ì‚°êµ¬",
                "113": "ì „ì£¼ì‹œ ë•ì§„êµ¬",
                "130": "êµ°ì‚°ì‹œ",
                "140": "ìµì‚°ì‹œ",
                "180": "ì •ìì‹œ",
                "190": "ë‚¨ì›ì‹œ",
                "210": "ê¹€ì œì‹œ",
                "710": "ì™„ì£¼êµ°",
                "720": "ì§„ì•ˆêµ°",
                "730": "ë¬´ì£¼êµ°",
                "740": "ì¥ìˆ˜êµ°",
                "750": "ì„ì‹¤êµ°",
                "770": "ìˆœì°½êµ°",
                "790": "ê³ ì°½êµ°",
                "800": "ë¶€ì•ˆêµ°"
            }
        },
        "46": {
            name: "ì „ë‚¨",
            sigungu: {
                "110": "ëª©í¬ì‹œ",
                "130": "ì—¬ìˆ˜ì‹œ",
                "150": "ìˆœì²œì‹œ",
                "170": "ë‚˜ì£¼ì‹œ",
                "230": "ê´‘ì–‘ì‹œ",
                "710": "ë‹´ì–‘êµ°",
                "720": "ê³¡ì„±êµ°",
                "730": "êµ¬ë¡€êµ°",
                "770": "ê³ í¥êµ°",
                "780": "ë³´ì„±êµ°",
                "800": "í™”ìˆœêµ°",
                "810": "ì¥í¥êµ°",
                "820": "ê°•ì§„êµ°",
                "830": "í•´ë‚¨êµ°",
                "840": "ì˜ì•”êµ°",
                "860": "ë¬´ì•ˆêµ°",
                "870": "í•¨í‰êµ°",
                "880": "ì˜ê´‘êµ°",
                "890": "ì¥ì„±êµ°",
                "900": "ì™„ë„êµ°",
                "910": "ì§„ë„êµ°"
            }
        },
        "47": {
            name: "ê²½ë¶",
            sigungu: {
                "111": "í¬í•­ì‹œ ë‚¨êµ¬",
                "113": "í¬í•­ì‹œ ë¶êµ¬",
                "130": "ê²½ì£¼ì‹œ",
                "150": "ê¹€ì²œì‹œ",
                "170": "ì•ˆë™ì‹œ",
                "190": "êµ¬ë¯¸ì‹œ",
                "210": "ì˜ì£¼ì‹œ",
                "230": "ì˜ì²œì‹œ",
                "250": "ìƒì£¼ì‹œ",
                "280": "ë¬¸ê²½ì‹œ",
                "290": "ê²½ì‚°ì‹œ",
                "720": "êµ°ìœ„êµ°",
                "730": "ì˜ì„±êµ°",
                "750": "ì²­ì†¡êµ°",
                "760": "ì˜ì–‘êµ°",
                "770": "ì˜ë•êµ°",
                "820": "ì²­ë„êµ°",
                "830": "ê³ ë ¹êµ°",
                "840": "ì„±ì£¼êµ°",
                "850": "ì¹ ê³¡êµ°",
                "900": "ì˜ˆì²œêµ°",
                "920": "ë´‰í™”êµ°",
                "930": "ìš¸ì§„êµ°",
                "940": "ìš¸ë¦‰êµ°"
            }
        },
        "48": {
            name: "ê²½ë‚¨",
            sigungu: {
                "121": "ì°½ì›ì‹œ ì˜ì°½êµ¬",
                "123": "ì°½ì›ì‹œ ì„±ì‚°êµ¬",
                "125": "ì°½ì›ì‹œ ë§ˆì‚°í•©í¬êµ¬",
                "127": "ì°½ì›ì‹œ ë§ˆì‚°íšŒì›êµ¬",
                "129": "ì°½ì›ì‹œ ì§„í•´êµ¬",
                "170": "ì§„ì£¼ì‹œ",
                "220": "í†µì˜ì‹œ",
                "240": "ì‚¬ì²œì‹œ",
                "250": "ê¹€í•´ì‹œ",
                "270": "ë°€ì–‘ì‹œ",
                "310": "ê±°ì œì‹œ",
                "330": "ì–‘ì‚°ì‹œ",
                "720": "ì˜ë ¹êµ°",
                "730": "í•¨ì•ˆêµ°",
                "740": "ì°½ë…•êµ°",
                "820": "ê³ ì„±êµ°",
                "840": "ë‚¨í•´êµ°",
                "850": "í•˜ë™êµ°",
                "860": "ì‚°ì²­êµ°",
                "870": "í•¨ì–‘êµ°",
                "880": "ê±°ì°½êµ°",
                "890": "í•©ì²œêµ°"
            }
        },
        "50": {
            name: "ì œì£¼íŠ¹ë³„ìì¹˜ë„",
            sigungu: {
                "110": "ì œì£¼ì‹œ",
                "130": "ì„œê·€í¬ì‹œ"
            }
        }
    };
    const lhPhoneNumbers = {
        "ì„œìš¸": "02-3416-3600",
        "ê²½ê¸°ë‚¨ë¶€": "031-250-8380",
        "ë¶€ì‚°ìš¸ì‚°": "051-460-5401",
        "ëŒ€êµ¬ê²½ë¶": "053-603-2640",
        "ê´‘ì£¼ì „ë‚¨": "062-360-3114",
        "ëŒ€ì „ì¶©ë‚¨": "042-470-0117",
        "ê°•ì›": "033-258-4400",
        "ê²½ë‚¨": "055-210-8680",
        "ì „ë¶": "063-230-6100",
        "ì œì£¼": "064-720-1000",
        "ì¶©ë¶": "1600-1004 (í†µí•© ì½œì„¼í„°)"
    };

    // â–¼â–¼â–¼ kakao.maps.loadë¥¼ ì‚¬ìš©í•˜ì—¬ SDK ë¡œë“œ í›„ ì•± ì‹œì‘ â–¼â–¼â–¼
    kakao.maps.load(() => {
        geocoder = new kakao.maps.services.Geocoder();
        setupRegionSearch();
        initializeMapAndLocation();
        setupReplySubmitListener();
    });

    function initializeMapAndLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                latitude = pos.coords.latitude;
                longitude = pos.coords.longitude;
                drawMap();
            }, error => {
                console.error("Geolocation ì—ëŸ¬:", error.message);
                alert("í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ìœ„ì¹˜ë¡œ ì§€ë„ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.");
                drawMap();
            });
        } else {
            alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            drawMap();
        }
    }

    function drawMap() {
        const mapContainer = document.getElementById('map');
        const mapOption = {
            center: new kakao.maps.LatLng(latitude, longitude),
            level: 8
        };
        map = new kakao.maps.Map(mapContainer, mapOption);
        kakao.maps.event.addListener(map, 'tilesloaded', function() {
            displayLocationInfo(latitude, longitude);
        });
        kakao.maps.event.addListener(map, 'idle', function() {
            const newCenter = map.getCenter();
            if (newCenter.getLat() !== latitude || newCenter.getLng() !== longitude) {
                latitude = newCenter.getLat();
                longitude = newCenter.getLng();
                displayLocationInfo(latitude, longitude);
            }
        });
    }

    function displayLocationInfo(lat, lng) {
        document.getElementById('info-lat').innerText = lat.toFixed(6);
        document.getElementById('info-lng').innerText = lng.toFixed(6);
        document.getElementById('info-addr').innerText = "í™•ì¸ ì¤‘...";
        document.getElementById('info-code').innerText = "í™•ì¸ ì¤‘...";
        geocoder.coord2RegionCode(lng, lat, (result, status) => {
            if (status === kakao.maps.services.Status.OK) {
                const bjdInfo = result.find(r => r.region_type === 'B');
                if (bjdInfo) {
                    document.getElementById('info-addr').innerText = bjdInfo.address_name;
                    const sidoCode = bjdInfo.code.substring(0, 2);
                    const sigunguCode = bjdInfo.code.substring(2, 5);
                    sidoSelect.value = sidoCode;
                    updateSigunguSelect(sidoCode);
                    sigunguSelect.value = sigunguCode;
                    updateBjdCode();
                } else {
                    document.getElementById('info-addr').innerText = "ë²•ì •ë™ ì •ë³´ ì—†ìŒ";
                    document.getElementById('info-code').innerText = "í™•ì¸ ë¶ˆê°€";
                }
            } else {
                document.getElementById('info-addr').innerText = "ìœ„ì¹˜ ì •ë³´ í™•ì¸ ì‹¤íŒ¨";
                document.getElementById('info-code').innerText = "í™•ì¸ ë¶ˆê°€";
            }
        });
    }

    function updateBjdCode() {
        const sidoCode = sidoSelect.value;
        const sigunguCode = sigunguSelect.value;
        document.getElementById('info-code').innerText = sidoCode && sigunguCode ? `${sidoCode}${sigunguCode}` : "ì½”ë“œ ì—†ìŒ";
    }

    function setupRegionSearch() {
        const searchBtn = document.getElementById('search-btn');
        const toggleAdvancedBtn = document.getElementById('toggle-advanced-search-btn');
        const advancedFilterPanel = document.getElementById('advanced-filter-panel');
        const applyFilterBtn = document.getElementById('apply-filter-btn');
        const resetFilterBtn = document.getElementById('reset-filter-btn');
        const loadingAnimation = document.getElementById('loading-animation');
        const listContent = document.getElementById('list-content');
        const areaPresetButtons = document.querySelectorAll('.area-preset-btn');
        const minAreaInput = document.getElementById('min-area');
        const maxAreaInput = document.getElementById('max-area');
        const typeFilterButtons = document.querySelectorAll('.type-filter-btn');
        for (const code in regionData) {
            const option = document.createElement('option');
            option.value = code;
            option.innerText = regionData[code].name;
            sidoSelect.appendChild(option);
        }
        sidoSelect.addEventListener('change', () => {
            updateSigunguSelect(sidoSelect.value);
            updateBjdCode();
        });
        sigunguSelect.addEventListener('change', updateBjdCode);
        toggleAdvancedBtn.addEventListener('click', () => {
            const isVisible = advancedFilterPanel.style.display === 'flex';
            advancedFilterPanel.style.display = isVisible ? 'none' : 'flex';
        });
        searchBtn.addEventListener('click', () => {
            updateBjdCode();
            loadingAnimation.style.display = 'block';
            listContent.style.display = 'none';

            const numOfRows = document.getElementById('num-of-rows-select').value;
            const sidoCode = sidoSelect.value;
            const sigunguCode = sigunguSelect.value;

            fetch(`/api/housing?brtcCode=${sidoCode}&signguCode=${sigunguCode}&numOfRows=${numOfRows}`).then(response => response.json()).then(data => {
                currentHousingList = data.hsmpList || [];
                clearMarkers();
                displayHousingOnMap(currentHousingList);
            }).catch(error => console.error('API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜:', error)).finally(() => {
                loadingAnimation.style.display = 'none';
                listContent.style.display = 'block';
            });
        });
        areaPresetButtons.forEach(button => {
            button.addEventListener('click', function() {
                minAreaInput.value = this.dataset.min;
                maxAreaInput.value = this.dataset.max;
                applyFilterBtn.click();
            });
        });
        typeFilterButtons.forEach(button => {
            button.addEventListener('click', function() {
                typeFilterButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                selectedHouseType = this.dataset.type;
                applyFilterBtn.click();
            });
        });
        applyFilterBtn.addEventListener('click', () => {
            const minDeposit = document.getElementById('min-deposit').value,
                maxDeposit = document.getElementById('max-deposit').value,
                minRent = document.getElementById('min-rent').value,
                maxRent = document.getElementById('max-rent').value,
                minArea = document.getElementById('min-area').value,
                maxArea = document.getElementById('max-area').value;
            const minDepositValue = minDeposit ? parseInt(minDeposit) * 10000 : 0,
                maxDepositValue = maxDeposit ? parseInt(maxDeposit) * 10000 : Infinity,
                minRentValue = minRent ? parseInt(minRent) * 10000 : 0,
                maxRentValue = maxRent ? parseInt(maxRent) * 10000 : Infinity,
                minAreaValue = minArea ? parseFloat(minArea) : 0,
                maxAreaValue = maxArea ? parseFloat(maxArea) : Infinity;
            const filteredList = currentHousingList.filter(item => {
                const deposit = Number(item.bassRentGtn),
                    rent = Number(item.bassMtRntchrg),
                    area = parseFloat(item.suplyPrvuseAr),
                    houseType = typeof item.houseTyNm === 'string' ? item.houseTyNm : '';
                const isDepositInRange = deposit >= minDepositValue && deposit <= maxDepositValue,
                    isRentInRange = rent >= minRentValue && rent <= maxRentValue,
                    isAreaInRange = area >= minAreaValue && area <= maxAreaValue;
                let isTypeMatch = true;
                if (selectedHouseType) {
                    const mainTypes = ['ë‹¤ê°€êµ¬ì£¼íƒ', 'ë‹¤ì„¸ëŒ€ì£¼íƒ', 'ì•„íŒŒíŠ¸', 'ì˜¤í”¼ìŠ¤í…”'];
                    if (selectedHouseType === 'etc') {
                        isTypeMatch = houseType && !mainTypes.includes(houseType);
                    } else {
                        isTypeMatch = houseType === selectedHouseType;
                    }
                }
                return isDepositInRange && isRentInRange && isAreaInRange && isTypeMatch;
            });
            clearMarkers();
            displayHousingOnMap(filteredList);
        });
        resetFilterBtn.addEventListener('click', () => {
            document.getElementById('min-deposit').value = '';
            document.getElementById('max-deposit').value = '';
            document.getElementById('min-rent').value = '';
            document.getElementById('max-rent').value = '';
            document.getElementById('min-area').value = '';
            document.getElementById('max-area').value = '';
            selectedHouseType = '';
            typeFilterButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelector('.type-filter-btn[data-type=""]').classList.add('active');
            clearMarkers();
            displayHousingOnMap(currentHousingList);
        });
        updateSigunguSelect(sidoSelect.value);
    }

    function updateSigunguSelect(sidoCode) {
        sigunguSelect.innerHTML = '';
        const sigunguList = regionData[sidoCode] ?.sigungu || {};
        for (const code in sigunguList) {
            const option = document.createElement('option');
            option.value = code;
            option.innerText = sigunguList[code];
            sigunguSelect.appendChild(option)
        }
    }

    function clearMarkers() {
        for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(null)
        }
        markers = [];
        if (activeInfoWindow) {
            activeInfoWindow.close();
            activeInfoWindow = null
        }
    }
    async function displayHousingOnMap(housingList) {
        const propertyList = document.getElementById('property-list');
        propertyList.innerHTML = '';
        if (!housingList || housingList.length === 0) {
            propertyList.innerHTML = '<li>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
            return
        }
        for (const item of housingList) {
            const geocodeResult = await new Promise(resolve => {
                geocoder.addressSearch(item.rnAdres, (result, status) => {
                    if (status === kakao.maps.services.Status.OK) {
                        resolve({
                            ...item,
                            coords: new kakao.maps.LatLng(result[0].y, result[0].x)
                        })
                    } else {
                        resolve(null)
                    }
                })
            });
            if (geocodeResult) {
                const {
                    coords,
                    ...itemData
                } = geocodeResult, marker = new kakao.maps.Marker({
                    map: map,
                    position: coords,
                    title: itemData.hsmpNm
                });
                markers.push(marker);
                const listItem = document.createElement('li');
                listItem.className = 'property-item';
                const propertyId = `${itemData.hsmpSn}-${itemData.styleNm}-${itemData.suplyCmnuseAr}`;
                listItem.dataset.propertyId = propertyId;
                const formattedDeposit = Number(itemData.bassRentGtn).toLocaleString('ko-KR'),
                    formattedRent = Number(itemData.bassMtRntchrg).toLocaleString('ko-KR');
                let ratingHtml = `<p class="rating-display">í‰ì  ì—†ìŒ</p>`;
                if (itemData.ratingCount > 0) {
                    const averageRating = itemData.averageRating || 0;
                    ratingHtml = `<p class="rating-display" title="í‰ê·  ${averageRating.toFixed(1)}ì ">
                                        <span class="star-filled">${'â˜…'.repeat(Math.round(averageRating))}</span><span class="star-empty">${'â˜†'.repeat(5-Math.round(averageRating))}</span>
                                        <strong>${averageRating.toFixed(1)}</strong> (${itemData.ratingCount}ëª…)
                                     </p>`
                }
                listItem.innerHTML = `<strong>${itemData.hsmpNm}</strong>${ratingHtml}<p>ì£¼ì†Œ: ${itemData.rnAdres}</p><p>ìœ í˜•: ${itemData.suplyTyNm||"ì •ë³´ì—†ìŒ"} / ${typeof itemData.houseTyNm==='object'?"ì •ë³´ì—†ìŒ":itemData.houseTyNm}</p><p>ì „ìš©ë©´ì : ${itemData.suplyPrvuseAr} ã¡</p><p class="price">ë³´ì¦ê¸ˆ: ${formattedDeposit}ì› / ì›”ì„¸: ${formattedRent}ì›</p><p>ê¸°ê´€: <span class="instt-button">${itemData.insttNm}</span></p>`;
                propertyList.appendChild(listItem);
                const openInfoWindow = () => {
                    if (activeInfoWindow) {
                        activeInfoWindow.close()
                    }
                    const iwContent = `<div style="padding:5px;width:260px;"><strong>${itemData.hsmpNm}</strong><br><small>${itemData.rnAdres}</small></div>`,
                        infowindow = new kakao.maps.InfoWindow({
                            content: iwContent,
                            removable: !0
                        });
                    infowindow.open(map, marker);
                    activeInfoWindow = infowindow
                };
                listItem.addEventListener('click', () => {
                    openInfoWindow();
                    map.panTo(coords);
                    document.querySelectorAll('.property-item').forEach(li => li.classList.remove('active-item'));
                    listItem.classList.add('active-item');
                    populateAndShowModal(itemData)
                });
                kakao.maps.event.addListener(marker, 'click', () => {
                    openInfoWindow();
                    listItem.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                    document.querySelectorAll('.property-item').forEach(li => li.classList.remove('active-item'));
                    listItem.classList.add('active-item');
                    populateAndShowModal(itemData)
                })
            }
            await new Promise(resolve => setTimeout(resolve, 50))
        }
    }
    closeModalBtn.addEventListener('click', () => {
        modalWrapper.style.display = 'none'
    });
    modalWrapper.addEventListener('click', e => {
        if (e.target === modalWrapper) {
            modalWrapper.style.display = 'none'
        }
    });
    async function populateAndShowModal(itemData) {
        const checkValue = value => !value || typeof value === 'object' ? 'ì •ë³´ì—†ìŒ' : value,
            formatNumber = value => isNaN(Number(value)) ? 'ì •ë³´ì—†ìŒ' : Number(value).toLocaleString('ko-KR'),
            findPhoneNumber = insttNm => {
                if (!insttNm) return '1600-1004 (í†µí•© ì½œì„¼í„°)';
                for (const region in lhPhoneNumbers) {
                    if (insttNm.includes(region)) return lhPhoneNumbers[region]
                }
                return '1600-1004 (í†µí•© ì½œì„¼í„°)'
            },
            entrpsTel = findPhoneNumber(itemData.insttNm),
            propertyId = `${itemData.hsmpSn}-${itemData.styleNm}-${itemData.suplyCmnuseAr}`;
        modalBody.innerHTML = `
            <table>
                <tr><th>ë‹¨ì§€ëª…</th><td>${checkValue(itemData.hsmpNm)}</td></tr>
                <tr><th>ì£¼ì†Œ</th><td>${checkValue(itemData.rnAdres)}</td></tr>
                <tr><th>ì¤€ê³µì¼ì</th><td>${checkValue(itemData.competDe)}</td></tr>
                <tr><th>ì„¸ëŒ€ìˆ˜</th><td>${checkValue(itemData.hshldCo)}</td></tr>
                <tr><th>ê³µê¸‰ìœ í˜•</th><td>${checkValue(itemData.suplyTyNm)}</td></tr>
                <tr><th>ì „ìš©ë©´ì </th><td>${checkValue(itemData.suplyPrvuseAr)} ã¡</td></tr>
                <tr><th>ê³µìš©ë©´ì </th><td>${checkValue(itemData.suplyCmnuseAr)} ã¡</td></tr>
                <tr><th>ì£¼íƒìœ í˜•</th><td>${checkValue(itemData.houseTyNm)}</td></tr>
                <tr><th>ë³´ì¦ê¸ˆ</th><td>${formatNumber(itemData.bassRentGtn)} ì›</td></tr>
                <tr><th>ì›”ì„ëŒ€ë£Œ</th><td>${formatNumber(itemData.bassMtRntchrg)} ì›</td></tr>
                <tr><th>ì „í™˜ë³´ì¦ê¸ˆ</th><td>${formatNumber(itemData.bassCnvrsGtnLmt)} ì›</td></tr>
                <tr><th>ê´€ë¦¬ ê¸°ê´€</th><td>${checkValue(itemData.insttNm)}</td></tr>
                <tr><th>ì—°ë½ì²˜</th><td>${entrpsTel}</td></tr>
            </table>
            <div class="star-rating-section">
                <h4>ë§¤ë¬¼ ë³„ì  ì£¼ê¸°</h4>
                <div class="stars" data-rating="0" data-property-id="${propertyId}">
                    <span class="star" data-value="1">â˜†</span><span class="star" data-value="2">â˜†</span><span class="star" data-value="3">â˜†</span><span class="star" data-value="4">â˜†</span><span class="star" data-value="5">â˜†</span>
                </div>
                <p class="rating-feedback"></p>
            </div>
            <div class="image-gallery-container">
                <div class="gallery-header"><div class="header-left"><span class="image-title">ë§¤ë¬¼ ì´ë¯¸ì§€</span></div></div>
                <div class="main-image-viewer"><button class="nav-arrow prev-arrow">â€¹</button><img id="current-image" src="" alt="Current Image"><button class="nav-arrow next-arrow">â€º</button><div class="image-counter"><span id="current-image-index"></span> / <span id="total-images"></span></div></div>
                <div class="thumbnail-gallery"><div class="thumbnail-scroll-wrapper"></div></div>
            </div>
            <div id="reply-section">
                <h4>ëŒ“ê¸€</h4><ul id="reply-list"></ul><div id="reply-pagination"></div>
                <form id="reply-form" onsubmit="return false;">
                    <textarea id="reply-textarea" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="2"></textarea>
                    <button id="reply-submit-btn" type="submit">ë“±ë¡</button>
                </form>
            </div>
            `;
        initGallery();
        document.getElementById('reply-list').dataset.propertyId = propertyId;
        fetchReplies(propertyId);
        try {
            const response = await fetch(`/api/ratings?propertyId=${propertyId}&userId=${currentUserId}`);
            let userRating = 0;
            if (response.status === 200) {
                const data = await response.json();
                userRating = data.ratingScore
            }
            setupStarRating(propertyId, userRating)
        } catch (error) {
            console.error("ì‚¬ìš©ì í‰ì  ì¡°íšŒ ì‹¤íŒ¨:", error);
            setupStarRating(propertyId, 0)
        }
        modalWrapper.style.display = 'flex'
    }

    function updateListItemRating(propertyId, ratingInfo) {
        const listItem = document.querySelector(`.property-item[data-property-id="${propertyId}"]`);
        if (!listItem) return;
        const ratingDisplay = listItem.querySelector('.rating-display');
        let ratingHtml = `<p class="rating-display">í‰ì  ì—†ìŒ</p>`;
        if (ratingInfo && ratingInfo.ratingCount > 0) {
            const averageRating = ratingInfo.averageRating || 0;
            ratingHtml = `<p class="rating-display" title="í‰ê·  ${averageRating.toFixed(1)}ì ">
                        <span class="star-filled">${'â˜…'.repeat(Math.round(averageRating))}</span><span class="star-empty">${'â˜†'.repeat(5-Math.round(averageRating))}</span>
                        <strong>${averageRating.toFixed(1)}</strong> (${ratingInfo.ratingCount}ëª…)
                     </p>`
        }
        ratingDisplay.outerHTML = ratingHtml
    }

    function setupStarRating(propertyId, initialRating) {
        const starContainer = document.querySelector('.stars'),
            stars = starContainer.querySelectorAll('.star'),
            feedback = document.querySelector('.rating-feedback');
        starContainer.dataset.rating = initialRating;
        updateStarsUI(initialRating);
        starContainer.addEventListener('mouseover', e => {
            if (e.target.classList.contains('star')) {
                const hoverValue = e.target.dataset.value;
                stars.forEach(s => s.classList.toggle('hover', s.dataset.value <= hoverValue))
            }
        });
        starContainer.addEventListener('mouseout', () => {
            stars.forEach(s => s.classList.remove('hover'))
        });
        starContainer.addEventListener('click', e => {
            if (e.target.classList.contains('star')) {
                const newRating = parseInt(e.target.dataset.value);
                feedback.textContent = 'ì €ì¥ ì¤‘...';
                fetch('/api/ratings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUserId,
                        propertyId: propertyId,
                        ratingScore: newRating
                    })
                }).then(response => {
                    if (!response.ok) throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
                    return response.json()
                }).then(newRatingInfo => {
                    console.log("ì„œë²„ë¡œë¶€í„° ìƒˆë¡œìš´ í‰ì  ì •ë³´ ìˆ˜ì‹ :", newRatingInfo);
                    starContainer.dataset.rating = newRating;
                    updateStarsUI(newRating);
                    feedback.textContent = `âœ“ ${newRating}ì ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                    setTimeout(() => {
                        feedback.textContent = ''
                    }, 2000);
                    updateListItemRating(propertyId, newRatingInfo)
                }).catch(error => {
                    console.error("í‰ì  ë“±ë¡ ì‹¤íŒ¨:", error);
                    alert('í‰ì  ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    feedback.textContent = '';
                    updateStarsUI(parseInt(starContainer.dataset.rating))
                })
            }
        });

        function updateStarsUI(rating) {
            stars.forEach(star => {
                star.classList.remove('hover');
                star.classList.toggle('filled', star.dataset.value <= rating)
            })
        }
    }

    function displayRepliesForPage(page) {
        currentReplyPage = page;
        const replyList = document.getElementById('reply-list');
        if (!replyList) return;
        replyList.innerHTML = '';
        if (allReplies.length === 0) {
            replyList.innerHTML = '<li>ì‘ì„±ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
            renderReplyPagination();
            return
        }
        const startIndex = (page - 1) * repliesPerPage,
            endIndex = startIndex + repliesPerPage,
            repliesToShow = allReplies.slice(startIndex, endIndex);
        repliesToShow.forEach(reply => {
            const li = document.createElement('li');
            li.className = 'reply-item';
            li.dataset.replyId = reply.id;
            li.innerHTML = ` <div class="reply-header"> <span class="user-id">${reply.userId}</span> <span class="timestamp">${new Date(reply.createdAt).toLocaleString()}</span> </div> <p class="reply-content">${reply.replyContent}</p> <div class="reply-actions"> <button class="edit-reply-btn">ìˆ˜ì •</button> <button class="delete-reply-btn">ì‚­ì œ</button> </div> `;
            replyList.appendChild(li)
        });
        renderReplyPagination()
    }

    function renderReplyPagination() {
        const paginationContainer = document.getElementById('reply-pagination');
        if (!paginationContainer) return;
        paginationContainer.innerHTML = '';
        const totalPages = Math.ceil(allReplies.length / repliesPerPage);
        if (totalPages <= 1) return;
        const prevBtn = document.createElement('button');
        prevBtn.className = 'page-btn';
        prevBtn.textContent = 'ì´ì „';
        prevBtn.disabled = currentReplyPage === 1;
        prevBtn.addEventListener('click', () => displayRepliesForPage(currentReplyPage - 1));
        paginationContainer.appendChild(prevBtn);
        for (let i = 1; i <= totalPages; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.className = 'page-btn';
            pageBtn.textContent = i;
            if (i === currentReplyPage) {
                pageBtn.classList.add('active')
            }
            pageBtn.addEventListener('click', () => displayRepliesForPage(i));
            paginationContainer.appendChild(pageBtn)
        }
        const nextBtn = document.createElement('button');
        nextBtn.className = 'page-btn';
        nextBtn.textContent = 'ë‹¤ìŒ';
        nextBtn.disabled = currentReplyPage === totalPages;
        nextBtn.addEventListener('click', () => displayRepliesForPage(currentReplyPage + 1));
        paginationContainer.appendChild(nextBtn)
    }

    function fetchReplies(propertyId, goToLastPage = !1) {
        allReplies = [];
        fetch(`/api/replies?propertyId=${propertyId}`).then(response => {
            if (!response.ok) throw new Error('ëŒ“ê¸€ ë¡œë”© ì‹¤íŒ¨');
            return response.json()
        }).then(replies => {
            allReplies = replies;
            if (goToLastPage) {
                const totalPages = Math.ceil(allReplies.length / repliesPerPage);
                displayRepliesForPage(totalPages || 1)
            } else {
                displayRepliesForPage(1)
            }
        }).catch(error => {
            console.error(error);
            const replyList = document.getElementById('reply-list');
            if (replyList) replyList.innerHTML = '<li>ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</li>'
        })
    }

    function setupReplySubmitListener() {
        modalBody.addEventListener('submit', e => {
            if (e.target.id === 'reply-form') {
                const textarea = document.getElementById('reply-textarea'),
                    content = textarea.value;
                if (!content.trim()) {
                    alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
                    return
                }
                const replyList = document.getElementById('reply-list'),
                    propertyId = replyList.dataset.propertyId;
                if (!propertyId) {
                    alert('ëŒ“ê¸€ì„ ë“±ë¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
                    return
                }
                fetch('/api/replies', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        replyContent: content,
                        propertyId: propertyId
                    })
                }).then(response => {
                    if (!response.ok) throw new Error('ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    textarea.value = '';
                    fetchReplies(propertyId, !0)
                }).catch(error => alert(error.message))
            }
        });
        modalBody.addEventListener('click', e => {
            const replyItem = e.target.closest('.reply-item');
            if (!replyItem) return;
            const propertyId = document.getElementById('reply-list').dataset.propertyId,
                replyId = replyItem.dataset.replyId;
            if (e.target.classList.contains('delete-reply-btn')) {
                if (!confirm('ì •ë§ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                fetch(`/api/replies/${replyId}`, {
                    method: 'DELETE'
                }).then(response => {
                    if (!response.ok) throw new Error('ì‚­ì œ ê¶Œí•œì´ ì—†ê±°ë‚˜, ì„œë²„ ì˜¤ë¥˜ì…ë‹ˆë‹¤.');
                    fetchReplies(propertyId)
                }).catch(error => alert(error.message))
            }
            if (e.target.classList.contains('edit-reply-btn')) {
                const originalContent = replyItem.querySelector('.reply-content').textContent,
                    newContent = prompt('ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:', originalContent);
                if (!newContent || newContent.trim() === originalContent) return;
                fetch(`/api/replies/${replyId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        replyContent: newContent
                    })
                }).then(response => {
                    if (!response.ok) throw new Error('ìˆ˜ì • ê¶Œí•œì´ ì—†ê±°ë‚˜, ì„œë²„ ì˜¤ë¥˜ì…ë‹ˆë‹¤.');
                    fetchReplies(propertyId)
                }).catch(error => alert(error.message))
            }
        })
    }
    const images = [{
        src: 'https://cdn.pixabay.com/photo/2015/04/24/10/18/studio-737569_1280.jpg',
        thumb: 'https://cdn.pixabay.com/photo/2015/04/24/10/18/studio-737569_1280.jpg'
    }, {
        src: 'https://cdn.pixabay.com/photo/2015/04/24/10/19/studio-737575_1280.jpg',
        thumb: 'https://cdn.pixabay.com/photo/2015/04/24/10/19/studio-737575_1280.jpg'
    }, {
        src: 'https://cdn.pixabay.com/photo/2015/04/24/10/18/studio-737572_1280.jpg',
        thumb: 'https://cdn.pixabay.com/photo/2015/04/24/10/18/studio-737572_1280.jpg'
    }, {
        src: 'https://cdn.pixabay.com/photo/2014/03/06/11/26/officetel-280748_1280.jpg',
        thumb: 'https://cdn.pixabay.com/photo/2014/03/06/11/26/officetel-280748_1280.jpg'
    }];
    let currentIndex = 0;
    const totalImages = images.length;
    let fixedImageWidth = null;
    let fixedImageHeight = null;

    function createThumbnails() {
        const thumbnailGallery = document.querySelector('.thumbnail-scroll-wrapper');
        if (!thumbnailGallery) return;
        thumbnailGallery.innerHTML = '';
        images.forEach((imgData, index) => {
            const thumb = document.createElement('img');
            thumb.className = 'thumbnail';
            thumb.src = imgData.thumb;
            thumb.alt = `Thumbnail ${index+1}`;
            thumb.dataset.index = index;
            thumbnailGallery.appendChild(thumb);
            thumb.addEventListener('click', () => {
                showImage(index)
            })
        })
    }

    function showImage(index) {
        if (totalImages === 0) return;
        const currentImageElement = document.getElementById('current-image'),
            currentImageIndexSpan = document.getElementById('current-image-index');
        if (!currentImageElement || !currentImageIndexSpan) return;
        currentIndex = index < 0 ? totalImages - 1 : index >= totalImages ? 0 : index;
        if (fixedImageWidth && fixedImageHeight) {
            currentImageElement.style.width = `${fixedImageWidth}px`;
            currentImageElement.style.height = `${fixedImageHeight}px`
        }
        currentImageElement.style.opacity = '0';
        setTimeout(() => {
            currentImageElement.src = images[currentIndex].src;
            currentImageElement.style.opacity = '1'
        }, 150);
        currentImageIndexSpan.textContent = currentIndex + 1;
        document.querySelectorAll('.thumbnail').forEach((thumb, idx) => {
            if (idx === currentIndex) {
                thumb.classList.add('active');
                thumb.scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest',
                    inline: 'center'
                })
            } else {
                thumb.classList.remove('active')
            }
        })
    }

    function initGallery() {
        const galleryContainer = document.querySelector('.image-gallery-container');
        if (images.length === 0) {
            if (galleryContainer) galleryContainer.style.display = 'none';
            return
        }
        if (galleryContainer) galleryContainer.style.display = 'flex';
        const prevArrow = document.querySelector('.prev-arrow'),
            nextArrow = document.querySelector('.next-arrow'),
            totalImagesSpan = document.getElementById('total-images'),
            mainImageViewer = document.querySelector('.main-image-viewer');
        if (!prevArrow || !nextArrow || !totalImagesSpan || !mainImageViewer) return;
        createThumbnails();
        totalImagesSpan.textContent = totalImages;
        const newPrevArrow = prevArrow.cloneNode(!0);
        prevArrow.parentNode.replaceChild(newPrevArrow, prevArrow);
        newPrevArrow.addEventListener('click', () => showImage(currentIndex - 1));
        const newNextArrow = nextArrow.cloneNode(!0);
        nextArrow.parentNode.replaceChild(newNextArrow, nextArrow);
        newNextArrow.addEventListener('click', () => showImage(currentIndex + 1));
        const firstImage = new Image();
        firstImage.onload = function() {
            const viewerWidth = mainImageViewer.clientWidth,
                viewerMaxHeight = 400,
                ratio = this.naturalWidth / this.naturalHeight;
            let newHeight = viewerWidth / ratio,
                newWidth = viewerWidth;
            if (newHeight > viewerMaxHeight) {
                newHeight = viewerMaxHeight;
                newWidth = viewerMaxHeight * ratio
            }
            fixedImageWidth = newWidth;
            fixedImageHeight = newHeight;
            showImage(0)
        };
        firstImage.src = images[0].src
    }
</script>
</body>

</html>